
DROP TABLE IF EXISTS TempData_CT_135701
;WITH BS
AS
(
SELECT AccountNumber,acctID BSAcctID, LastStatementDate
FROM BSegment_Primary BP WITH (NOLOCK)
WHERE acctID IN (13061331,1661871,819706,576043,371464,10658706,1697310,2205796,568271,13550200,
 6448733,881282,4900533,38515,435576,1265629,7837062,1549096,1899619,21953418,
 1240762,663184,1292152,4124763,1981832,1678239,653073,3748691,56387,11411604,
 791403,736375,2204365,1835724,399065,602455,604789,14370354,1292030,191620,
 1575001,9407634,4343835,2230458,701957,8940408,1286282,8490002,171484,14016590)
),
CPS
AS
(
	SELECT BS.*, CPS.acctId, CPS.DisputesAmtNS
	FROM CPSgmentAccounts CPS WITH (NOLOCK)
	JOIN CPSgmentCreditCard CPC WITH (NOLOCK) ON (CPS.acctId = CPC.acctID)
	JOIN BS ON (CPS.parent02AID = BS.BSAcctID)
	WHERE CPS.CurrentBalance+CPC.CurrentBalanceCO <= 0
	AND DisputesAmtNS <= 0
)
, ILP
AS
( 
SELECT CPS.*,parent02AID, PlanID, CurrentBalance, PaidOffDate, 
DATEADD(SS, 86397, CAST(EOMONTH(PaidOffDate) AS DATETIME)) PaidOffDate_EOM, ScheduleID,
RANK() OVER(PARTITION BY PlanID ORDER BY ActivityOrder DESC) [Rank]
FROM ILPScheduleDetailSummary ILPS WITH (NOLOCK)
JOIN CPS WITH (NOLOCK) ON (ILPS.PlanID = CPS.acctID)
WHERE PaidOffDate IS NOT NULL
)
, PaidOffPlans
AS
(
SELECT *, DATEDIFF(MM, PaidOffDate_EOM, LastStatementDate) MonthCount, 
TRY_CAST(0 AS INT) JobStatus
FROM ILP 
WHERE Rank = 1
)
SELECT * 
INTO TempData_CT_135701
FROM PaidOffPlans
WHERE MonthCount >= 3
 


--SELECT * FROM #TempData_CT_135701
--SELECT * FROM TempXRef_CT_135701

DROP TABLE IF EXISTS TempXRef_CT_135701
SELECT X.*
INTO TempXRef_CT_135701
FROM XRefTable X WITH (NOLOCK)
JOIN TempData_CT_135701 T ON (X.ParentATID = 51 AND X.parentAID = T.parent02AID AND ChildATID = 52 AND X.ChildAID = T.PlanID)
