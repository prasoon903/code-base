--SELECT acctID, TranTime, TranID, ROW_NUMBER() OVER (PARTITION BY NULL ORDER BY TranTime)  [Row]
--FROM LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.CommonTNP WITH (NOLOCK) 
--WHERE acctID = 1290188 AND TranID > 0

SELECT acctID, COUNT(1) FROm LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.CommonTNP WITH (NOLOCK) WHERE acctID IN (2246270, 2436874, 18438243) GROUP BY acctID

SELECT acctID, COUNT(1) FROm LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.ErrorTNP WITH (NOLOCK) WHERE acctID IN (2246270, 2436874, 18438243) GROUP BY acctID


--SELECT * FROm LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.CommonTNP WITH (NOLOCK) WHERE acctID = 2246270 ORDER BY TranTIME
--SELECT * FROm LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.CommonTNP WITH (NOLOCK) WHERE acctID = 2436874 ORDER BY TranTIME
--SELECT * FROm LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.ErrorTNP WITH (NOLOCK) WHERE acctID = 2436874 ORDER BY TranTIME
--SELECT * FROm LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.PurchaseReversalRecord WITH (NOLOCK) WHERE parent02AID = 2246270
--SELECT * FROm LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.CCard_Primary WITH (NOLOCK) WHERE TranID = 69004173769
--2436874
--2246270
--18438243

DECLARE @CurrentTime DATETIME = DATEADD(MINUTE, 10, GETDATE()), @acctID INT

SET @acctID = 2436874

;WITH CTE
AS
(
SELECT acctID, @CurrentTime TranTime, TranID, ROW_NUMBER() OVER (PARTITION BY NULL ORDER BY TranTime)  [Row]
FROM LS_ProdDRGSDB01.CCGS_CoreIssue.dbo.CommonTNP WITH (NOLOCK) 
WHERE acctID = @acctID AND TranID > 0
)
, CCARD AS
(
SELECT CP.TranID, CP.TranTime, CP.PostTime, C.TranTime TNPTime, [Row],
CASE WHEN CP.TranTime < CP.PostTime THEN 0 ELSE 1 END AS TransactionType
FROM CCard_Primary CP WITH (NOLOCK)
JOIN CTE C ON (CP.TranID = C.TranID)
)
SELECT *, DATEADD(MINUTE, [Row]*3, TNPTime) NewTime,
CASE WHEN TransactionType = 0 THEN 
'UPDATE TOP(1) CCard_Primary SET PostTime = ''' + TRY_CONVERT(VARCHAR(20), DATEADD(MINUTE, [Row]*3, TNPTime), 20) + ''' WHERE TranID = ' + TRY_CAST(TranID AS VARCHAR)
ELSE 
'UPDATE TOP(1) CCard_Primary SET TranTime = ''' + TRY_CONVERT(VARCHAR(20), DATEADD(MINUTE, [Row]*3, TNPTime), 20) + ''' + PostTime = ''' + TRY_CONVERT(VARCHAR(20), DATEADD(MINUTE, [Row]*3, TNPTime), 20) + ''' WHERE TranID = ' + TRY_CAST(TranID AS VARCHAR)
END AS CCardResult,
'UPDATE TOP(1) CommonTNP SET TranTime = ''' + TRY_CONVERT(VARCHAR(20), DATEADD(MINUTE, [Row]*3, TNPTime), 20) + ''' WHERE TranID = ' + TRY_CAST(TranID AS VARCHAR)
FROM CCARD

